<!-- app/views/admin/badges/_form.html.erb -->
<%= form_with(model: [:admin, badge], local: true) do |form| %>
  <div class="mb-3">
    <%= form.label :title, t('admin.badges.form.title'), class: 'form-label' %>
    <%= form.text_field :title, class: 'form-control', required: true %>
  </div>

  <div class="mb-3">
    <%= form.label :image_url, t('admin.badges.form.image_url'), class: 'form-label' %>
    <%= form.url_field :image_url, class: 'form-control' %>
  </div>
  
  <div class="mb-3" data-controller="badge-value">
    <%= form.label :rule, t('admin.badges.form.rule'), class: 'form-label' %>
    <%= form.select :rule,
                    BadgeAssigner::RULES.map { |key| [t("admin.badges.rules.#{key}"), key] },
                    { include_blank: true },
                    { class: 'form-select', required: true, data: { badge_value_target: "rule", action: "change->badge-value#switchValueField" } } %>

    <div class="mt-3" data-badge-value-target="valueField">
      <% case badge.rule %>
      <% when "all_category_tests_passed" %>
        <%= render partial: "admin/badges/value_fields/category_select", locals: { form: form } %>
      <% when "all_level_tests_passed" %>
        <%= render partial: "admin/badges/value_fields/level_select", locals: { form: form } %>
      <% else %>
        <%= render partial: "admin/badges/value_fields/text_field", locals: { form: form } %>
      <% end %>
    </div>

    <template data-badge-value-target="template" data-rule="all_category_tests_passed">
      <%= render partial: "admin/badges/value_fields/category_select", locals: { form: form } %>
    </template>
    <template data-badge-value-target="template" data-rule="all_level_tests_passed">
      <%= render partial: "admin/badges/value_fields/level_select", locals: { form: form } %>
    </template>
    <template data-badge-value-target="template" data-rule="default">
      <%= render partial: "admin/badges/value_fields/text_field", locals: { form: form } %>
    </template>
  </div>

  <div class="mb-3" data-controller="image-preview">
    <%= form.label :image, t('admin.badges.form.image'), class: 'form-label' %>
    <%= form.select :image, @images.map { |img| [img, img] }, {include_blank: t('admin.labels.select_image')}, {class: 'form-select', data: { action: "change->image-preview#updateImage", "image-preview-target": "select" }} %>
    <div class="mt-3">
      <img src="/badges/<%= form.object.image  %>" data-image-preview-target="preview" width="64" height="64" style="width: 64px; height: 64px; object-fit: cover;">
    </div>
  </div>

  <div class="mb-3 form-check form-switch">
    <%= form.check_box :status, {data: { controller: "switch", action: "click->switch#toggle" }, class: "form-check-input"},'active', 'inactive' %>
    <%= form.label :status, t("admin.badges.form.#{badge.status ? 'active' : 'inactive'}"), class: "form-check-label", id: "switchLabel" %>
  </div>

  <div class="d-flex justify-content-end">
    <%= form.submit t('admin.labels.save'), class: 'btn btn-primary me-2' %>
    <%= link_to t('admin.labels.cancel'), admin_badges_path, class: 'btn btn-secondary' %>
  </div>
<% end %>

<script type="text/javascript">
    // Stimulus controller for toggle switch
    document.addEventListener("DOMContentLoaded", () => {
        const application = Stimulus.Application.start()
        application.register("switch", class extends Stimulus.Controller {
            static targets = ["label"]

            toggle(event) {
                this.labelTarget.textContent = event.target.checked ? "<%= t('admin.badges.form.active') %>" : "<%= t('admin.badges.form.inactive') %>"
            }
        })
    })
</script>